# _*_ MakeFile _*_

##############################################################################
# VARIABLES
##############################################################################

# ----------------------------------------------------------------------------
# Default compiler
# ----------------------------------------------------------------------------
CC := clang
AS := as
LD := ld

# ----------------------------------------------------------------------------
# Default compiler flags
# ----------------------------------------------------------------------------
INCDIRS := -I.
OPTIM := -O2
CFLAGS := -std=c99 -fstrict-aliasing $(OPTIM) $(INCDIRS)
ASFLAGS := -q $(INCDIRS)

LDLIBS := -lc
LDOPTIM := -dead_strip
LDFLAGS := -execute -dynamic -pie $(LDOPTIM) $(LDLIBS)

# ----------------------------------------------------------------------------
# Files
# ----------------------------------------------------------------------------
SRCS := order.c main.c
ASMS := $(patsubst %.c, %.s, $(SRCS))
OBJS := $(patsubst %.c, %.o, $(SRCS))


##############################################################################
# COMMANDS
##############################################################################

all: order $(ASMS)

# ----------------------------------------------------------------------------
# Executable
# ----------------------------------------------------------------------------
order: $(OBJS)
	$(LD) $^ $(LDFLAGS) -o $@

# ----------------------------------------------------------------------------
# Assemble machine instructions files into object files using `as` assembler.
# ----------------------------------------------------------------------------
%.o: %.s
	$(AS) $(ASFLAGS) -o $@ $<

# ----------------------------------------------------------------------------
# Generate assembly files using `clang` with optimization options
# ----------------------------------------------------------------------------
%.s: %.c
	$(CC) -o $@ -S $< $(CFLAGS)

# ----------------------------------------------------------------------------
# Clean
# ----------------------------------------------------------------------------
.PHONY: clean
clean:
	rm -f $(ASMS) $(OBJS) order

